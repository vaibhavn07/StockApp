const router = require('express').Router();
const User = require('../schema/User')
const mongoose = require('mongoose');
// const axios = require('axios')
// const { body, validationResult } = require('express-validator')
const bcrypt = require('bcryptjs')
const jwt = require('jsonwebtoken')
const loginMiddleware = require('../middleware/loginMiddleware');
const { default: axios } = require('axios');
require('../db/db');
require('dotenv').config()
const JWT_KEY = 'vaibhavn2007@gmail.com'


const arr = [
    {
        "Meta Data": {
            "1. Information": "Intraday (5min) open, high, low, close prices and volume",
            "2. Symbol": "IBM",
            "3. Last Refreshed": "2024-05-17 19:55:00",
            "4. Interval": "5min",
            "5. Output Size": "Compact",
            "6. Time Zone": "US/Eastern"
        },
        "Time Series (5min)": {
            "2024-05-17 19:55:00": {
                "1. open": "169.0190",
                "2. high": "169.0190",
                "3. low": "169.0190",
                "4. close": "169.0190",
                "5. volume": "1"
            },
            "2024-05-17 19:50:00": {
                "1. open": "168.9800",
                "2. high": "168.9800",
                "3. low": "168.9700",
                "4. close": "168.9700",
                "5. volume": "156"
            },
            "2024-05-17 19:45:00": {
                "1. open": "169.0100",
                "2. high": "169.0300",
                "3. low": "168.9700",
                "4. close": "168.9700",
                "5. volume": "57"
            },
            "2024-05-17 19:40:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "169.0000",
                "4. close": "169.0100",
                "5. volume": "520"
            },
            "2024-05-17 19:35:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0100",
                "4. close": "169.0100",
                "5. volume": "416"
            },
            "2024-05-17 19:30:00": {
                "1. open": "169.0000",
                "2. high": "169.0000",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "55"
            },
            "2024-05-17 19:25:00": {
                "1. open": "169.0000",
                "2. high": "169.0000",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "10"
            },
            "2024-05-17 19:10:00": {
                "1. open": "169.0080",
                "2. high": "169.0080",
                "3. low": "169.0080",
                "4. close": "169.0080",
                "5. volume": "1"
            },
            "2024-05-17 19:05:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "306"
            },
            "2024-05-17 19:00:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "169.0050",
                "4. close": "169.0050",
                "5. volume": "947861"
            },
            "2024-05-17 18:55:00": {
                "1. open": "169.0000",
                "2. high": "169.0000",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "16"
            },
            "2024-05-17 18:50:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0100",
                "4. close": "169.0100",
                "5. volume": "1"
            },
            "2024-05-17 18:45:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0100",
                "4. close": "169.0100",
                "5. volume": "2"
            },
            "2024-05-17 18:40:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "150"
            },
            "2024-05-17 18:35:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0100",
                "4. close": "169.0100",
                "5. volume": "10"
            },
            "2024-05-17 18:30:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "169.0050",
                "4. close": "169.0050",
                "5. volume": "947271"
            },
            "2024-05-17 18:25:00": {
                "1. open": "169.0000",
                "2. high": "169.0100",
                "3. low": "169.0000",
                "4. close": "169.0100",
                "5. volume": "4"
            },
            "2024-05-17 18:15:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0100",
                "4. close": "169.0100",
                "5. volume": "1"
            },
            "2024-05-17 18:10:00": {
                "1. open": "169.0000",
                "2. high": "169.0000",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "4"
            },
            "2024-05-17 18:00:00": {
                "1. open": "168.8100",
                "2. high": "168.8100",
                "3. low": "168.8100",
                "4. close": "168.8100",
                "5. volume": "9"
            },
            "2024-05-17 17:40:00": {
                "1. open": "169.0000",
                "2. high": "169.0000",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "5"
            },
            "2024-05-17 17:35:00": {
                "1. open": "168.9200",
                "2. high": "169.0100",
                "3. low": "168.9100",
                "4. close": "169.0000",
                "5. volume": "2049"
            },
            "2024-05-17 17:30:00": {
                "1. open": "168.9100",
                "2. high": "168.9200",
                "3. low": "168.8000",
                "4. close": "168.8000",
                "5. volume": "128"
            },
            "2024-05-17 17:25:00": {
                "1. open": "168.9180",
                "2. high": "168.9180",
                "3. low": "168.9180",
                "4. close": "168.9180",
                "5. volume": "5"
            },
            "2024-05-17 17:20:00": {
                "1. open": "168.8800",
                "2. high": "168.8800",
                "3. low": "168.8800",
                "4. close": "168.8800",
                "5. volume": "3"
            },
            "2024-05-17 17:15:00": {
                "1. open": "168.8000",
                "2. high": "168.9190",
                "3. low": "168.8000",
                "4. close": "168.9190",
                "5. volume": "4"
            },
            "2024-05-17 17:10:00": {
                "1. open": "168.9180",
                "2. high": "168.9180",
                "3. low": "168.9100",
                "4. close": "168.9100",
                "5. volume": "4"
            },
            "2024-05-17 17:05:00": {
                "1. open": "168.8020",
                "2. high": "168.8500",
                "3. low": "168.8020",
                "4. close": "168.8500",
                "5. volume": "3"
            },
            "2024-05-17 17:00:00": {
                "1. open": "168.8000",
                "2. high": "168.8010",
                "3. low": "168.8000",
                "4. close": "168.8010",
                "5. volume": "110"
            },
            "2024-05-17 16:55:00": {
                "1. open": "168.9200",
                "2. high": "168.9200",
                "3. low": "168.9000",
                "4. close": "168.9000",
                "5. volume": "21"
            },
            "2024-05-17 16:50:00": {
                "1. open": "168.9500",
                "2. high": "168.9500",
                "3. low": "168.9000",
                "4. close": "168.9200",
                "5. volume": "1551"
            },
            "2024-05-17 16:40:00": {
                "1. open": "168.9200",
                "2. high": "168.9500",
                "3. low": "168.9200",
                "4. close": "168.9500",
                "5. volume": "17"
            },
            "2024-05-17 16:35:00": {
                "1. open": "168.9500",
                "2. high": "168.9600",
                "3. low": "168.9000",
                "4. close": "168.9000",
                "5. volume": "262"
            },
            "2024-05-17 16:30:00": {
                "1. open": "168.9000",
                "2. high": "168.9600",
                "3. low": "168.9000",
                "4. close": "168.9100",
                "5. volume": "49"
            },
            "2024-05-17 16:25:00": {
                "1. open": "168.9600",
                "2. high": "168.9600",
                "3. low": "168.9600",
                "4. close": "168.9600",
                "5. volume": "40"
            },
            "2024-05-17 16:20:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "169.0300",
                "4. close": "169.0300",
                "5. volume": "164"
            },
            "2024-05-17 16:15:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "168.9000",
                "4. close": "168.9600",
                "5. volume": "66"
            },
            "2024-05-17 16:10:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "168.8400",
                "4. close": "168.9200",
                "5. volume": "1001498"
            },
            "2024-05-17 16:05:00": {
                "1. open": "169.7500",
                "2. high": "169.7500",
                "3. low": "168.8800",
                "4. close": "168.8800",
                "5. volume": "367"
            },
            "2024-05-17 16:00:00": {
                "1. open": "169.0700",
                "2. high": "169.7500",
                "3. low": "167.2700",
                "4. close": "169.0300",
                "5. volume": "2121001"
            },
            "2024-05-17 15:55:00": {
                "1. open": "168.9000",
                "2. high": "169.1100",
                "3. low": "168.8700",
                "4. close": "169.0700",
                "5. volume": "212106"
            },
            "2024-05-17 15:50:00": {
                "1. open": "168.6400",
                "2. high": "168.9800",
                "3. low": "168.5600",
                "4. close": "168.9100",
                "5. volume": "80951"
            },
            "2024-05-17 15:45:00": {
                "1. open": "168.6500",
                "2. high": "168.6800",
                "3. low": "168.5700",
                "4. close": "168.6500",
                "5. volume": "45721"
            },
            "2024-05-17 15:40:00": {
                "1. open": "168.7400",
                "2. high": "168.7700",
                "3. low": "168.6200",
                "4. close": "168.6400",
                "5. volume": "31617"
            },
            "2024-05-17 15:35:00": {
                "1. open": "168.8600",
                "2. high": "168.8700",
                "3. low": "168.7000",
                "4. close": "168.7200",
                "5. volume": "19807"
            },
            "2024-05-17 15:30:00": {
                "1. open": "168.7500",
                "2. high": "168.8350",
                "3. low": "168.7400",
                "4. close": "168.8300",
                "5. volume": "24396"
            },
            "2024-05-17 15:25:00": {
                "1. open": "168.8800",
                "2. high": "168.8800",
                "3. low": "168.6500",
                "4. close": "168.7100",
                "5. volume": "24359"
            },
            "2024-05-17 15:20:00": {
                "1. open": "168.7000",
                "2. high": "168.8600",
                "3. low": "168.6900",
                "4. close": "168.8300",
                "5. volume": "23410"
            },
            "2024-05-17 15:15:00": {
                "1. open": "168.6100",
                "2. high": "168.6900",
                "3. low": "168.6000",
                "4. close": "168.6800",
                "5. volume": "16710"
            },
            "2024-05-17 15:10:00": {
                "1. open": "168.5200",
                "2. high": "168.6100",
                "3. low": "168.5100",
                "4. close": "168.6000",
                "5. volume": "13409"
            },
        }
    },
    {
        "Meta Data": {
            "1. Information": "Intraday (5min) open, high, low, close prices and volume",
            "2. Symbol": "TCS",
            "3. Last Refreshed": "2024-05-17 19:55:00",
            "4. Interval": "5min",
            "5. Output Size": "Compact",
            "6. Time Zone": "US/Eastern"
        },
        "Time Series (5min)": {
            "2024-05-17 19:55:00": {
                "1. open": "169.0190",
                "2. high": "169.0190",
                "3. low": "169.0190",
                "4. close": "169.0190",
                "5. volume": "1"
            },
            "2024-05-17 19:50:00": {
                "1. open": "168.9800",
                "2. high": "168.9800",
                "3. low": "168.9700",
                "4. close": "168.9700",
                "5. volume": "156"
            },
            "2024-05-17 19:45:00": {
                "1. open": "169.0100",
                "2. high": "169.0300",
                "3. low": "168.9700",
                "4. close": "168.9700",
                "5. volume": "57"
            },
            "2024-05-17 19:40:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "169.0000",
                "4. close": "169.0100",
                "5. volume": "520"
            },
            "2024-05-17 19:35:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0100",
                "4. close": "169.0100",
                "5. volume": "416"
            },
            "2024-05-17 19:30:00": {
                "1. open": "169.0000",
                "2. high": "169.0000",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "55"
            },
            "2024-05-17 19:25:00": {
                "1. open": "169.0000",
                "2. high": "169.0000",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "10"
            },
            "2024-05-17 19:10:00": {
                "1. open": "169.0080",
                "2. high": "169.0080",
                "3. low": "169.0080",
                "4. close": "169.0080",
                "5. volume": "1"
            },
            "2024-05-17 19:05:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "306"
            },
            "2024-05-17 19:00:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "169.0050",
                "4. close": "169.0050",
                "5. volume": "947861"
            },
            "2024-05-17 18:55:00": {
                "1. open": "169.0000",
                "2. high": "169.0000",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "16"
            },
            "2024-05-17 18:50:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0100",
                "4. close": "169.0100",
                "5. volume": "1"
            },
            "2024-05-17 18:45:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0100",
                "4. close": "169.0100",
                "5. volume": "2"
            },
            "2024-05-17 18:40:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "150"
            },
            "2024-05-17 18:35:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0100",
                "4. close": "169.0100",
                "5. volume": "10"
            },
            "2024-05-17 18:30:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "169.0050",
                "4. close": "169.0050",
                "5. volume": "947271"
            },
            "2024-05-17 18:25:00": {
                "1. open": "169.0000",
                "2. high": "169.0100",
                "3. low": "169.0000",
                "4. close": "169.0100",
                "5. volume": "4"
            },
            "2024-05-17 18:15:00": {
                "1. open": "169.0100",
                "2. high": "169.0100",
                "3. low": "169.0100",
                "4. close": "169.0100",
                "5. volume": "1"
            },
            "2024-05-17 18:10:00": {
                "1. open": "169.0000",
                "2. high": "169.0000",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "4"
            },
            "2024-05-17 18:00:00": {
                "1. open": "168.8100",
                "2. high": "168.8100",
                "3. low": "168.8100",
                "4. close": "168.8100",
                "5. volume": "9"
            },
            "2024-05-17 17:40:00": {
                "1. open": "169.0000",
                "2. high": "169.0000",
                "3. low": "169.0000",
                "4. close": "169.0000",
                "5. volume": "5"
            },
            "2024-05-17 17:35:00": {
                "1. open": "168.9200",
                "2. high": "169.0100",
                "3. low": "168.9100",
                "4. close": "169.0000",
                "5. volume": "2049"
            },
            "2024-05-17 17:30:00": {
                "1. open": "168.9100",
                "2. high": "168.9200",
                "3. low": "168.8000",
                "4. close": "168.8000",
                "5. volume": "128"
            },
            "2024-05-17 17:25:00": {
                "1. open": "168.9180",
                "2. high": "168.9180",
                "3. low": "168.9180",
                "4. close": "168.9180",
                "5. volume": "5"
            },
            "2024-05-17 17:20:00": {
                "1. open": "168.8800",
                "2. high": "168.8800",
                "3. low": "168.8800",
                "4. close": "168.8800",
                "5. volume": "3"
            },
            "2024-05-17 17:15:00": {
                "1. open": "168.8000",
                "2. high": "168.9190",
                "3. low": "168.8000",
                "4. close": "168.9190",
                "5. volume": "4"
            },
            "2024-05-17 17:10:00": {
                "1. open": "168.9180",
                "2. high": "168.9180",
                "3. low": "168.9100",
                "4. close": "168.9100",
                "5. volume": "4"
            },
            "2024-05-17 17:05:00": {
                "1. open": "168.8020",
                "2. high": "168.8500",
                "3. low": "168.8020",
                "4. close": "168.8500",
                "5. volume": "3"
            },
            "2024-05-17 17:00:00": {
                "1. open": "168.8000",
                "2. high": "168.8010",
                "3. low": "168.8000",
                "4. close": "168.8010",
                "5. volume": "110"
            },
            "2024-05-17 16:55:00": {
                "1. open": "168.9200",
                "2. high": "168.9200",
                "3. low": "168.9000",
                "4. close": "168.9000",
                "5. volume": "21"
            },
            "2024-05-17 16:50:00": {
                "1. open": "168.9500",
                "2. high": "168.9500",
                "3. low": "168.9000",
                "4. close": "168.9200",
                "5. volume": "1551"
            },
            "2024-05-17 16:40:00": {
                "1. open": "168.9200",
                "2. high": "168.9500",
                "3. low": "168.9200",
                "4. close": "168.9500",
                "5. volume": "17"
            },
            "2024-05-17 16:35:00": {
                "1. open": "168.9500",
                "2. high": "168.9600",
                "3. low": "168.9000",
                "4. close": "168.9000",
                "5. volume": "262"
            },
            "2024-05-17 16:30:00": {
                "1. open": "168.9000",
                "2. high": "168.9600",
                "3. low": "168.9000",
                "4. close": "168.9100",
                "5. volume": "49"
            },
            "2024-05-17 16:25:00": {
                "1. open": "168.9600",
                "2. high": "168.9600",
                "3. low": "168.9600",
                "4. close": "168.9600",
                "5. volume": "40"
            },
            "2024-05-17 16:20:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "169.0300",
                "4. close": "169.0300",
                "5. volume": "164"
            },
            "2024-05-17 16:15:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "168.9000",
                "4. close": "168.9600",
                "5. volume": "66"
            },
            "2024-05-17 16:10:00": {
                "1. open": "169.0300",
                "2. high": "169.0300",
                "3. low": "168.8400",
                "4. close": "168.9200",
                "5. volume": "1001498"
            },
            "2024-05-17 16:05:00": {
                "1. open": "169.7500",
                "2. high": "169.7500",
                "3. low": "168.8800",
                "4. close": "168.8800",
                "5. volume": "367"
            },
            "2024-05-17 16:00:00": {
                "1. open": "169.0700",
                "2. high": "169.7500",
                "3. low": "167.2700",
                "4. close": "169.0300",
                "5. volume": "2121001"
            },
            "2024-05-17 15:55:00": {
                "1. open": "168.9000",
                "2. high": "169.1100",
                "3. low": "168.8700",
                "4. close": "169.0700",
                "5. volume": "212106"
            },
            "2024-05-17 15:50:00": {
                "1. open": "168.6400",
                "2. high": "168.9800",
                "3. low": "168.5600",
                "4. close": "168.9100",
                "5. volume": "80951"
            },
            "2024-05-17 15:45:00": {
                "1. open": "168.6500",
                "2. high": "168.6800",
                "3. low": "168.5700",
                "4. close": "168.6500",
                "5. volume": "45721"
            },
            "2024-05-17 15:40:00": {
                "1. open": "168.7400",
                "2. high": "168.7700",
                "3. low": "168.6200",
                "4. close": "168.6400",
                "5. volume": "31617"
            },
            "2024-05-17 15:35:00": {
                "1. open": "168.8600",
                "2. high": "168.8700",
                "3. low": "168.7000",
                "4. close": "168.7200",
                "5. volume": "19807"
            },
            "2024-05-17 15:30:00": {
                "1. open": "168.7500",
                "2. high": "168.8350",
                "3. low": "168.7400",
                "4. close": "168.8300",
                "5. volume": "24396"
            },
            "2024-05-17 15:25:00": {
                "1. open": "168.8800",
                "2. high": "168.8800",
                "3. low": "168.6500",
                "4. close": "168.7100",
                "5. volume": "24359"
            },
            "2024-05-17 15:20:00": {
                "1. open": "168.7000",
                "2. high": "168.8600",
                "3. low": "168.6900",
                "4. close": "168.8300",
                "5. volume": "23410"
            },
            "2024-05-17 15:15:00": {
                "1. open": "168.6100",
                "2. high": "168.6900",
                "3. low": "168.6000",
                "4. close": "168.6800",
                "5. volume": "16710"
            },
            "2024-05-17 15:10:00": {
                "1. open": "168.5200",
                "2. high": "168.6100",
                "3. low": "168.5100",
                "4. close": "168.6000",
                "5. volume": "13409"
            },
            "2024-05-17 15:05:00": {
                "1. open": "168.5100",
                "2. high": "168.5400",
                "3. low": "168.4700",
                "4. close": "168.5100",
                "5. volume": "15108"
            },
        }
    }
]

router.post('/login', async (req, res) => {
    const {
        email,
        password
    } = req.body;

    const user1 = await User.findOne({ email: email })
    if (!user1) {
        return res.status(404).json("Invalid Credentials");
    }
    const pass = await bcrypt.compare(password,user1.password); 
    if (pass) {
        console.log('user found');
        const obj = {
            user: {
                name: user1.name,
                email: email,
            }
        };
        const data = jwt.sign(obj, JWT_KEY);
        res.setHeader('auth-token',data);
        return res.status(200).json(data);
    }
    
    return res.status(404).json('Invalid Credentials');
});

router.get('/getData',loginMiddleware,async (req,res)=>{
    try {
        const user = await User.findOne({email:req.user.email});
        console.log(user)
        console.log(user.stocks)
        return res.status(200).json(user);
    }    
    catch(e){
        return res.status(400).json('error occured');
    }
});


router.post('/signup', async (req, res) => {
    const {
        name, email, password
    } = req.body;
    const user1 = await User.findOne({ email });
    if (user1) {
        return res.status(200).json("Already user exist with the mail");
    }

    const salt = await bcrypt.genSalt(10);
    const hashPassword = await bcrypt.hash(password,salt);
    const user = new User({
        name, email, password:hashPassword
    });
    const stock = new Stock({
        Userid:user._id
    });
    user.save();
    return res.status(201).json("Account Created Successfully");
});


router.get('/deletestock:id',loginMiddleware, async (req, res) => {
    const email = req.user.email;
    const id = req.params.id;
    const user = await User.findOne({ email: email });
    // user.stocks = user.stocks.filter(element => element !== id);
    console.log(user.stocks)
    user.stocks = user.stocks.filter((element)=>element!=id.slice(1,id.length));
    user.save();
    console.log(user.stocks)
    return res.status(200).json("deleted");
});

router.post('/addstock:id',loginMiddleware,async (req, res) => {
    const email = req.user.email;
    const id = req.params.id;
    const user = await User.findOne({ email: email });
    if(user.stocks.indexOf(id.slice(1,id.length))==-1){
        let data;
        if(id.slice(1,id.length)=='IBM'){
            data = arr[0];
        }
        else{
            data = arr[1];
        }
        console.log(data);
        user.stocks.push(data);
        user.save();
        console.log(user.stocks)
        return res.status(201).json("added");
    }
    return res.status(208).json("Already Available");
})



module.exports = router;